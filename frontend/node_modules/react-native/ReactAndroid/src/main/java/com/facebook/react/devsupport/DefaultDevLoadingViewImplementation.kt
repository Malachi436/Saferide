/*
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

package com.facebook.react.devsupport

import android.content.Context
import android.graphics.Rect
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.view.WindowManager
import android.widget.FrameLayout
import android.widget.PopupWindow
import android.widget.TextView
import androidx.core.view.children
import com.facebook.common.logging.FLog
import com.facebook.react.R
import com.facebook.react.bridge.UiThreadUtil
import com.facebook.react.common.ReactConstants
import com.facebook.react.devsupport.interfaces.DevLoadingViewManager
import java.util.Locale

public interface DevLoadingMessageDisplay {
  public fun showMessage(message: String)
  public fun hideMessage()
}

/**
 * Default implementation of Dev Loading View Manager to display loading messages on top of the
 * screen. All methods are thread safe.
 */
public class DefaultDevLoadingViewImplementation(
  private val reactInstanceDevHelper: ReactInstanceDevHelper
) : DevLoadingViewManager {

  override fun showMessage(message: String) {
    if (!isEnabled) {
      return
    }
    UiThreadUtil.runOnUiThread { showInternal(message) }
  }

  override fun updateProgress(status: String?, done: Int?, total: Int?) {
    if (!isEnabled) {
      return
    }
    UiThreadUtil.runOnUiThread {
      val percentage =
        if (done != null && total != null && total > 0)
          String.format(Locale.getDefault(), " %.1f%%", done.toFloat() / total * 100)
        else ""
      showMessage(
        "${status ?: "Loading"}${percentage}\u2026") // `...` character at the end
    }
  }

  public override fun hide() {
    if (isEnabled) {
      UiThreadUtil.runOnUiThread { hideInternal() }
    }
  }

  private fun showInternal(message: String) {
    val currentActivity = reactInstanceDevHelper.currentActivity as DevLoadingMessageDisplay
    currentActivity.showMessage(message)
  }

  private fun hideInternal() {
    val currentActivity = reactInstanceDevHelper.currentActivity as DevLoadingMessageDisplay
    currentActivity.hideMessage()
  }

  private val context: Context?
    get() = reactInstanceDevHelper.currentActivity

  public companion object {
    private var isEnabled = true

    public fun setDevLoadingEnabled(enabled: Boolean) {
      isEnabled = enabled
    }
  }
}

