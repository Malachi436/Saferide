{
  "$schema": "https://qoder.ai/rules/schema.json",
  "project": {
    "name": "ROSAgo",
    "description": "School Transport Management System",
    "version": "1.0.0"
  },
  "projectType": "monorepo",
  "rootDirectories": ["frontend", "backend"],
  "safeMode": "strict",
  "patchMode": {
    "enabled": true,
    "requireApproval": true,
    "patchFolder": "qoder_patches",
    "naming": "patch_<timestamp>_<summary>"
  },
  "monorepo": {
    "structure": {
      "frontend": {
        "path": "frontend",
        "technology": "Expo React Native",
        "purpose": "Mobile application for parents, drivers, and administrators"
      },
      "backend": {
        "path": "backend",
        "technology": "NestJS + Prisma + Postgres + Redis + WebSockets + BullMQ",
        "purpose": "API backend with real-time capabilities and background processing",
        "protected": true
      }
    }
  },
  "modules": {
    "backend": {
      "boundaries": {
        "AuthModule": {
          "path": "src/modules/auth",
          "responsibilities": [
            "JWT access and refresh token management",
            "User authentication flows",
            "Password hashing and validation"
          ],
          "routes": ["/auth"],
          "exports": ["AuthService", "JwtStrategy"]
        },
        "UsersModule": {
          "path": "src/modules/users",
          "responsibilities": [
            "User CRUD operations",
            "User profile management",
            "User role assignments"
          ],
          "exports": ["UsersService"]
        },
        "DriversModule": {
          "path": "src/modules/drivers",
          "responsibilities": [
            "Driver profile management",
            "Driver-bus assignments",
            "Driver availability tracking"
          ],
          "exports": ["DriversService"]
        },
        "ChildrenModule": {
          "path": "src/modules/children",
          "responsibilities": [
            "Child profile management",
            "Parent-child relationships",
            "Child route assignments"
          ],
          "exports": ["ChildrenService"]
        },
        "BusesModule": {
          "path": "src/modules/buses",
          "responsibilities": [
            "Bus fleet management",
            "Bus capacity tracking",
            "Bus-driver assignments"
          ],
          "exports": ["BusesService"]
        },
        "RoutesModule": {
          "path": "src/modules/routes",
          "responsibilities": [
            "Route planning and management",
            "Route stops definition",
            "Route scheduling"
          ],
          "exports": ["RoutesService"]
        },
        "TripsModule": {
          "path": "src/modules/trips",
          "responsibilities": [
            "Trip scheduling",
            "Trip status tracking",
            "Trip history management"
          ],
          "exports": ["TripsService"]
        },
        "GpsModule": {
          "path": "src/modules/gps",
          "responsibilities": [
            "Real-time GPS tracking",
            "Location data processing",
            "Bus location updates"
          ],
          "exports": ["GpsService"]
        },
        "AttendanceModule": {
          "path": "src/modules/attendance",
          "responsibilities": [
            "Child pickup/drop-off tracking",
            "Attendance records",
            "Attendance reporting"
          ],
          "exports": ["AttendanceService"]
        },
        "NotificationsModule": {
          "path": "src/modules/notifications",
          "responsibilities": [
            "Push notifications",
            "SMS notifications",
            "Email notifications",
            "Notification preferences"
          ],
          "exports": ["NotificationsService"]
        },
        "PaymentsModule": {
          "path": "src/modules/payments",
          "responsibilities": [
            "MoMo Hubtle payment integration",
            "Payment processing",
            "Payment history tracking",
            "Subscription management"
          ],
          "exports": ["PaymentsService"]
        },
        "AnalyticsModule": {
          "path": "src/modules/analytics",
          "responsibilities": [
            "Usage analytics",
            "Performance metrics",
            "Reporting dashboards",
            "Data insights"
          ],
          "exports": ["AnalyticsService"]
        },
        "AdminModule": {
          "path": "src/modules/admin",
          "responsibilities": [
            "System administration",
            "User management",
            "Configuration settings",
            "Audit logging"
          ],
          "exports": ["AdminService"]
        },
        "TenancyModule": {
          "path": "src/modules/tenancy",
          "responsibilities": [
            "Multi-tenancy support",
            "Company/school isolation",
            "Tenant-specific configurations"
          ],
          "exports": ["TenancyService"]
        },
        "RealtimeModule": {
          "path": "src/modules/realtime",
          "responsibilities": [
            "WebSocket connections",
            "Real-time event broadcasting",
            "Location streaming",
            "Client subscriptions"
          ],
          "exports": ["RealtimeGateway"]
        },
        "PrismaModule": {
          "path": "src/prisma",
          "responsibilities": [
            "Database connectivity",
            "ORM operations",
            "Transaction management"
          ],
          "exports": ["PrismaService"],
          "global": true
        }
      }
    }
  },
  "routing": {
    "backend": {
      "prefix": "/api",
      "modules": {
        "auth": "/auth",
        "users": "/users",
        "drivers": "/drivers",
        "children": "/children",
        "buses": "/buses",
        "routes": "/routes",
        "trips": "/trips",
        "gps": "/gps",
        "attendance": "/attendance",
        "notifications": "/notifications",
        "payments": "/payments",
        "analytics": "/analytics",
        "admin": "/admin"
      },
      "constraints": {
        "authRoutes": {
          "prefix": "/auth",
          "protected": false,
          "methods": ["POST"]
        },
        "protectedRoutes": {
          "prefix": "/api",
          "protected": true,
          "exceptions": ["/auth"]
        }
      }
    }
  },
  "build": {
    "backend": {
      "commands": {
        "install": "npm install",
        "build": "npm run build",
        "dev": "npm run start:dev",
        "prod": "npm run start:prod",
        "test": "npm run test",
        "testWatch": "npm run test:watch",
        "testCoverage": "npm run test:cov",
        "prismaGenerate": "npm run prisma:generate",
        "prismaMigrate": "npm run prisma:migrate",
        "prismaStudio": "npm run prisma:studio"
      },
      "entry": "src/main.ts",
      "output": "dist"
    },
    "frontend": {
      "commands": {
        "install": "npm install",
        "dev": "npx expo start",
        "android": "npx expo run:android",
        "ios": "npx expo run:ios",
        "web": "npx expo start --web"
      }
    }
  },
  "environment": {
    "backend": {
      "files": [".env", ".env.example"],
      "requiredVariables": [
        "DATABASE_URL",
        "REDIS_URL",
        "JWT_ACCESS_SECRET",
        "JWT_REFRESH_SECRET",
        "JWT_ACCESS_EXPIRES_IN",
        "JWT_REFRESH_EXPIRES_IN",
        "PORT",
        "NODE_ENV",
        "HUBTLE_API_KEY",
        "HUBTLE_WEBHOOK_SECRET"
      ]
    },
    "frontend": {
      "files": [".env", ".env.example"],
      "requiredVariables": [
        "EXPO_PUBLIC_API_URL"
      ]
    }
  },
  "integration": {
    "frontendToBackend": {
      "apiBaseUrl": "/api",
      "authentication": {
        "method": "Bearer Token",
        "header": "Authorization",
        "tokenRefresh": "/auth/refresh"
      },
      "dataFlow": {
        "realtime": {
          "protocol": "WebSocket",
          "endpoint": "/gateway"
        },
        "rest": {
          "protocol": "HTTP/HTTPS",
          "contentType": "application/json"
        }
      }
    }
  },
  "database": {
    "prisma": {
      "version": "5.22.0",
      "schemaProtection": {
        "rules": [
          "DO NOT modify schema.prisma unless explicitly asked",
          "All schema changes must be reviewed",
          "Migrations must be generated using Prisma CLI",
          "Bidirectional relations must be explicitly defined",
          "Schema changes require explicit approval"
        ],
        "locked": true,
        "allowFormatOnly": true
      },
      "namingConventions": {
        "models": "PascalCase",
        "fields": "camelCase",
        "enums": "PascalCase",
        "relations": "Explicitly defined"
      },
      "constraints": {
        "serviceInjection": "PrismaService must remain global and imported into all modules using @Global()",
        "providerPattern": "Maintain all existing provider injection patterns"
      }
    }
  },
  "realtime": {
    "websocket": {
      "constraints": [
        "WebSocket gateway must be implemented in RealtimeModule",
        "JWT authentication required for all connections",
        "Event broadcasting must use appropriate rooms/channels",
        "Connection management must handle disconnects gracefully",
        "Rate limiting should be implemented for event emissions"
      ],
      "events": {
        "busLocation": "locationUpdate",
        "tripStatus": "tripUpdate",
        "attendance": "attendanceUpdate",
        "notifications": "newNotification"
      }
    }
  },
  "workers": {
    "bullmq": {
      "queues": [
        "gps.heartbeat",
        "notification.outbound",
        "payment.process_webhook",
        "analytics"
      ],
      "integration": "Worker processes must follow BullMQ integration patterns",
      "monitoring": "Queue monitoring and error handling required",
      "protected": true
    }
  },
  "docker": {
    "constraints": [
      "No editing Docker setup unless explicitly instructed",
      "Docker Compose files must maintain current service definitions",
      "Environment variables must be properly mapped"
    ],
    "protected": true,
    "forbiddenChanges": [
      "docker-compose.dev.yml",
      "Dockerfile"
    ]
  },
  "api": {
    "contracts": {
      "constraints": [
        "All backend API contracts must remain consistent unless instructed",
        "Breaking changes require explicit approval",
        "Versioning should follow semantic versioning"
      ]
    }
  },
  "ui": {
    "constraints": [
      "No frontend UI modifications without explicit request",
      "Existing navigation structure must be preserved",
      "Component reusability should be maintained"
    ]
  },
  "testing": {
    "backend": {
      "unitTests": "Jest testing framework",
      "e2eTests": "Supertest for API testing",
      "coverage": "Minimum 80% coverage recommended"
    },
    "allowedChanges": ["Jest tests", "e2e tests"],
    "forbiddenChanges": ["Deleting test directories"]
  },
  "frontend": {
    "path": "frontend",
    "language": "TypeScript",
    "framework": "React Native (Expo SDK 54)",
    "expoVersion": "~54.0.0",
    "reactVersion": "19.1.0",
    "reactNativeVersion": "0.81.5",
    "criticalConfigFiles": {
      "babel.config.js": {
        "locked": true,
        "protectionLevel": "CRITICAL",
        "reason": "NativeWind v4 Babel plugin conflict - caused 4 days of debugging",
        "rules": [
          "NEVER add 'nativewind/babel' plugin (NativeWind v4 does not use Babel plugin)",
          "NEVER add any plugins before 'react-native-reanimated/plugin'",
          "'react-native-reanimated/plugin' MUST be the last plugin in the array",
          "DO NOT add worklets plugins",
          "DO NOT modify preset order",
          "DO NOT remove reanimated plugin",
          "Any modification will cause: '.plugins is not a valid Plugin property' error"
        ],
        "workingConfiguration": {
          "presets": [["babel-preset-expo", { "lazyImports": true }]],
          "plugins": ["react-native-reanimated/plugin"]
        },
        "forbiddenPlugins": [
          "nativewind/babel",
          "react-native-worklets/plugin",
          "any other babel plugins"
        ]
      },
      "package.json": {
        "locked": true,
        "protectionLevel": "CRITICAL",
        "lockedDependencies": {
          "expo": "~54.0.0",
          "react": "19.1.0",
          "react-native": "0.81.5",
          "nativewind": "^4.0.1",
          "react-native-reanimated": "~4.1.1",
          "react-native-worklets": "0.5.1",
          "react-native-web": "~0.21.2",
          "@react-native-async-storage/async-storage": "2.2.0",
          "expo-blur": "~15.0.7",
          "expo-camera": "~17.0.9",
          "expo-status-bar": "~3.0.8",
          "react-native-safe-area-context": "~5.6.0",
          "react-native-screens": "~4.16.0",
          "react-native-svg": "15.12.1",
          "@types/react": "~19.1.10",
          "typescript": "~5.9.2"
        },
        "rules": [
          "NEVER change React version from 19.1.0 (React Native 0.81.5 requires React 19.1.0)",
          "NEVER downgrade to React 18.x",
          "NEVER change Expo SDK version from ~54.0.0",
          "NEVER change React Native version from 0.81.5",
          "NEVER remove react-native-worklets (required peer dependency for Reanimated 4.1.x)",
          "NEVER change NativeWind version (must stay on v4.x)",
          "NEVER change @types/react version (must be ~19.1.x for compatibility)",
          "Use 'npx expo install <package>' to add new packages, NOT 'npm install'",
          "Any version change will cause ERESOLVE peer dependency conflicts"
        ],
        "allowedChanges": [
          "Adding new business logic packages using 'npx expo install'",
          "Adding utility libraries compatible with Expo SDK 54"
        ]
      },
      "metro.config.js": {
        "locked": true,
        "protectionLevel": "CRITICAL",
        "rules": [
          "DO NOT modify - keep Expo's default Metro configuration",
          "DO NOT add custom transformers",
          "DO NOT modify resolver settings",
          "DO NOT override default config",
          "Any modification will break Metro bundler"
        ],
        "workingConfiguration": "Must use getDefaultConfig from 'expo/metro-config'"
      },
      ".npmrc": {
        "locked": true,
        "protectionLevel": "CRITICAL",
        "content": "legacy-peer-deps=true",
        "rules": [
          "DO NOT remove this file",
          "DO NOT change to legacy-peer-deps=false",
          "Required for Expo SDK 54 dependency resolution",
          "Prevents ERESOLVE errors during npm install"
        ]
      },
      "app.json": {
        "locked": false,
        "protectionLevel": "MODERATE",
        "lockedFields": {
          "expo.scheme": "rosago",
          "expo.icon": "./assets/icon.png",
          "expo.splash.image": "./assets/splash.png",
          "expo.android.adaptiveIcon.foregroundImage": "./assets/adaptive-icon.png",
          "expo.web.favicon": "./assets/favicon.png",
          "expo.extra.eas.projectId": "9c979fed-a1db-4e4c-ac6a-e4841682d37a"
        },
        "rules": [
          "DO NOT change 'scheme' value (breaks deep linking)",
          "DO NOT change asset file paths unless files are moved",
          "DO NOT remove EAS project ID",
          "Asset files referenced must exist"
        ],
        "allowedChanges": [
          "name (display name)",
          "version (app version)",
          "orientation",
          "permissions",
          "backgroundColor",
          "iOS/Android specific settings"
        ]
      },
      "tailwind.config.js": {
        "locked": false,
        "protectionLevel": "LOW",
        "lockedSettings": {
          "presets": "[require('nativewind/preset')]"
        },
        "rules": [
          "DO NOT remove 'require(nativewind/preset)' from presets array",
          "DO NOT change content paths (styles won't work)"
        ],
        "allowedChanges": [
          "Add custom colors in theme.extend",
          "Add custom fonts",
          "Add spacing, borders, shadows",
          "Add Tailwind plugins"
        ]
      },
      "tsconfig.json": {
        "locked": false,
        "protectionLevel": "LOW",
        "lockedSettings": {
          "extends": "expo/tsconfig.base"
        },
        "rules": [
          "MUST extend 'expo/tsconfig.base'",
          "DO NOT change module resolution to incompatible settings"
        ],
        "allowedChanges": [
          "Strict mode settings",
          "Path aliases",
          "Include/exclude patterns"
        ]
      },
      ".gitignore": {
        "locked": false,
        "protectionLevel": "LOW",
        "requiredEntries": [
          "node_modules/",
          ".expo/",
          ".expo-shared/"
        ],
        "rules": [
          "DO NOT remove .expo/ entry (prevents committing machine-specific state)",
          "DO NOT remove node_modules/ entry"
        ]
      }
    },
    "nativeWindVersion": "4.0.1",
    "nativeWindRules": [
      "NativeWind v4 does NOT use a Babel plugin",
      "NativeWind v4 works through Metro config, not Babel",
      "NEVER add 'nativewind/babel' to babel.config.js",
      "Old tutorials showing 'nativewind/babel' are for v3, not v4"
    ],
    "requiredAssets": {
      "files": [
        "assets/icon.png",
        "assets/splash.png",
        "assets/adaptive-icon.png",
        "assets/favicon.png"
      ],
      "rules": [
        "All asset files must exist",
        "Asset paths in app.json must match actual files",
        "Missing assets will cause expo-doctor validation errors"
      ]
    },
    "developmentWorkflow": {
      "startCommand": "npx expo start --go --clear",
      "expoGoMode": true,
      "clearCacheOnStart": true,
      "rules": [
        "Always start with --clear flag to avoid cached errors",
        "Use --go flag for Expo Go mode on physical devices",
        "Use --tunnel flag if same Wi-Fi network doesn't work"
      ]
    },
    "allowedChanges": [
      "All files in src/ directory (screens, components, navigation, stores, utils)",
      "UI/UX modifications in components",
      "Navigation structure (routes, stacks, tabs)",
      "State management (Zustand stores)",
      "API integration code",
      "TypeScript types and interfaces",
      "Theme customization (colors, fonts in tailwind.config.js)",
      "Asset files (images, icons)",
      "Business logic",
      "Styles using Tailwind classes"
    ],
    "forbiddenChanges": [
      "babel.config.js (LOCKED - NativeWind v4 compatibility)",
      "package.json dependency versions (LOCKED - Expo SDK 54 requirements)",
      "metro.config.js (LOCKED - Expo defaults)",
      ".npmrc (LOCKED - peer dependency resolution)",
      "Core React/React Native/Expo versions",
      "Adding Babel plugins",
      "Modifying build configurations",
      "Changing module resolution",
      "Replacing NativeWind",
      "Downgrading to React 18.x",
      "Upgrading/downgrading Expo SDK"
    ],
    "errorRecovery": {
      "commonErrors": {
        ".plugins is not a valid Plugin property": {
          "cause": "Invalid or non-existent Babel plugin in babel.config.js",
          "solution": "Remove 'nativewind/babel' - NativeWind v4 doesn't use it",
          "prevention": "Never modify babel.config.js"
        },
        "ERESOLVE could not resolve": {
          "cause": "Peer dependency conflicts in package.json",
          "solution": "Restore locked dependency versions, run 'npm install --legacy-peer-deps'",
          "prevention": "Never change core package versions"
        },
        "Metro bundler failed": {
          "cause": "Metro configuration issue",
          "solution": "Restore metro.config.js to Expo defaults",
          "prevention": "Never modify metro.config.js"
        },
        "Cannot find module 'expo/tsconfig.base'": {
          "cause": "tsconfig.json not extending Expo base",
          "solution": "Restore 'extends': 'expo/tsconfig.base'",
          "prevention": "Always extend expo/tsconfig.base"
        }
      },
      "recoverySteps": [
        "1. Identify which critical file was modified",
        "2. Run 'git restore <file>' to restore from Git",
        "3. Clear all caches: Remove .expo and node_modules/.cache",
        "4. Reinstall: npm install --legacy-peer-deps",
        "5. Test: npx expo start --go --clear"
      ]
    },
    "packageInstallation": {
      "rules": [
        "ALWAYS use 'npx expo install <package>' NOT 'npm install <package>'",
        "Expo install ensures SDK 54 compatibility",
        "After installing packages, always test with --clear flag",
        "Check expo-doctor after package changes: npx expo-doctor"
      ]
    },
    "testing": {
      "physicalDevice": {
        "method": "Expo Go",
        "setup": [
          "Install Expo Go from Play Store/App Store",
          "Connect phone and PC to same Wi-Fi network",
          "Scan QR code from terminal",
          "Wait 30-60 seconds for initial bundle"
        ],
        "troubleshooting": [
          "If QR doesn't work: Use tunnel mode (npx expo start --tunnel)",
          "If connection fails: Check Windows Firewall allows Node.js",
          "If bundling fails: Clear cache with --clear flag"
        ]
      }
    },
    "historyNote": "This configuration was locked after resolving a 4-day debugging session caused by NativeWind v4 Babel plugin conflict. DO NOT modify critical files without extreme caution."
  },
  "backend": {
    "path": "backend",
    "language": "TypeScript",
    "framework": "NestJS",
    "allowedChanges": [
      "creating new modules",
      "adding DTOs",
      "adding services",
      "adding controllers",
      "improving typings",
      "adding tests"
    ],
    "forbiddenChanges": [
      "modifying prisma/schema.prisma unless explicitly instructed",
      "changing Docker configs",
      "changing database connection config",
      "editing migrations manually",
      "modifying .env variables",
      "touching the worker queue implementation without approval",
      "modifying database setup",
      "modifying backend configs",
      "modifying backend core logic without approval"
    ],
    "protected": true
  },
  "apiIntegration": {
    "backendUrl": "http://localhost:3000",
    "integrationMode": "strict",
    "rules": [
      "Qoder must not invent API routes",
      "Qoder must respect existing NestJS controller paths",
      "Qoder must not modify API response shapes unless asked"
    ]
  },
  "generalRules": {
    "neverModify": [
      ".gitignore",
      ".gitattributes",
      ".env",
      "*.lock",
      "node_modules",
      "frontend/babel.config.js",
      "frontend/metro.config.js",
      "frontend/.npmrc"
    ],
    "criticalProtections": {
      "frontend": [
        "babel.config.js is LOCKED - caused 4 days of debugging",
        "package.json core dependencies are LOCKED - Expo SDK 54 requirements",
        "metro.config.js is LOCKED - Expo defaults only",
        ".npmrc is LOCKED - required for peer dependency resolution",
        "NEVER add 'nativewind/babel' plugin - NativeWind v4 doesn't use it",
        "NEVER change React from 19.1.0 or React Native from 0.81.5",
        "ALWAYS use 'npx expo install' for new packages, NOT 'npm install'"
      ],
      "backend": [
        "Prisma schema is LOCKED unless explicitly instructed",
        "Docker configs are LOCKED",
        "Database setup is LOCKED",
        "Worker queue implementation requires approval"
      ]
    },
    "requireConfirmationFor": [
      "dependency upgrades",
      "schema changes",
      "Docker config changes",
      "authentication logic changes",
      "WebSocket gateway changes",
      "frontend build configuration changes",
      "Babel/Metro configuration changes",
      "Expo SDK version changes"
    ],
    "generatePatchesOnly": true,
    "analysisRequiredBeforeChanges": true,
    "emergencyRecovery": {
      "frontendBabelError": "If '.plugins is not a valid Plugin property' error: restore babel.config.js from Git, remove .expo/, run: npx expo start --clear",
      "peerDependencyError": "If 'ERESOLVE' error: restore package.json from Git, run: npm install --legacy-peer-deps",
      "generalRecovery": "Always commit working state before modifying critical config files"
    }
  }
}